#!/usr/bin/env bash
# asdf-install-all - Install all tools from .tool-versions
#
# Examples:
#   asdf-install-all    # Install from current directory's .tool-versions

set -euo pipefail

# Colors
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
BLUE='\033[0;36m'
NC='\033[0m'

show_usage() {
    cat << EOF
Usage: $(basename "$0")

Install all tools and versions from .tool-versions file.

This script will:
  1. Read .tool-versions
  2. Add missing asdf plugins
  3. Install all specified versions

Examples:
  $(basename "$0")
EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ] 2>/dev/null; then
    show_usage
    exit 0
fi

# Check if asdf is installed
if ! command -v asdf &> /dev/null; then
    echo "${RED}Error: asdf not found${NC}" >&2
    echo "Install asdf first: brew install asdf"
    exit 1
fi

# Check if .tool-versions exists
if [ ! -f .tool-versions ]; then
    echo "${RED}Error: .tool-versions not found${NC}" >&2
    exit 1
fi

echo "${BLUE}Installing tools from .tool-versions${NC}"
echo ""

# Read .tool-versions
while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^#.*$ ]] && continue
    [[ -z "$line" ]] && continue
    
    # Parse tool and version
    TOOL=$(echo "$line" | awk '{print $1}')
    VERSION=$(echo "$line" | awk '{print $2}')
    
    echo "${YELLOW}Processing: $TOOL $VERSION${NC}"
    
    # Check if plugin is installed
    if ! asdf plugin list | grep -q "^${TOOL}$"; then
        echo "  Adding plugin: $TOOL"
        if asdf plugin add "$TOOL"; then
            echo "  ${GREEN}✓${NC} Plugin added"
        else
            echo "  ${RED}✗${NC} Failed to add plugin"
            continue
        fi
    else
        echo "  Plugin already installed"
    fi
    
    # Check if version is installed
    if asdf list "$TOOL" 2>/dev/null | grep -q "$VERSION"; then
        echo "  ${GREEN}✓${NC} Version $VERSION already installed"
    else
        echo "  Installing version: $VERSION"
        if asdf install "$TOOL" "$VERSION"; then
            echo "  ${GREEN}✓${NC} Version installed"
        else
            echo "  ${RED}✗${NC} Failed to install version"
        fi
    fi
    
    echo ""
done < .tool-versions

echo "${GREEN}✓ Installation complete${NC}"
echo ""
echo "Installed tools:"
asdf current
