#!/usr/bin/env bash
# git-recent - Show recently checked out branches
#
# Examples:
#   git-recent       # Show last 10 branches
#   git-recent 20    # Show last 20 branches

set -euo pipefail

# Colors
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
GRAY='\033[0;90m'
NC='\033[0m'

show_usage() {
    cat << EOF
Usage: $(basename "$0") [N]

Show recently checked out branches.

Arguments:
  N    Number of branches to show (default: 10)

Examples:
  $(basename "$0")      # Show last 10 branches
  $(basename "$0") 20   # Show last 20 branches
EOF
}

# Check if we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not a git repository" >&2
    exit 1
fi

N=10

# Parse arguments
if [ $# -gt 0 ]; then
    if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
        show_usage
        exit 0
    elif [[ "$1" =~ ^[0-9]+$ ]]; then
        N=$1
    else
        echo "Error: Invalid number: $1" >&2
        exit 1
    fi
fi

CURRENT=$(git branch --show-current)

echo "${YELLOW}Recent branches (last $N):${NC}"
echo ""

git reflog | \
    grep -o "checkout: moving from .* to .*" | \
    sed 's/checkout: moving from .* to //' | \
    awk '!seen[$0]++' | \
    head -n "$N" | \
    nl -w2 -s'. ' | \
    while IFS= read -r line; do
        BRANCH=$(echo "$line" | sed 's/^[0-9]*\. //')
        if [ "$BRANCH" = "$CURRENT" ]; then
            echo "${GREEN}$line ${GREEN}(current)${NC}"
        else
            echo "$line"
        fi
    done
